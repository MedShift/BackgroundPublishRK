<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BackgroundPublishRK: Background Publish</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BackgroundPublishRK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Background Publish </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a class="anchor" id="md_README"></a> Background publish is a Particle firmware library that makes it easy to do <code>Particle.publish</code> from a background thread. This can be helpful in assuring that your loop() stays responsive, even if you have connection problems. This is most commonly an issue with cellular devices in fringe areas and for mobile cellular devices.</p>
<p >Doing a <code>Particle.publish</code> from regular loop code can cause delays, ranging from a few seconds to at worst nearly 5 minutes. For near-real-time applications this can be unacceptable. This library assures that you can request a publish and it will not block.</p>
<p >This library does not support queuing of multiple events; that will be handled by a different library. This only handles the basic case of single-event background publish and is very light-weight.</p>
<h1>Simple Example</h1>
<p >Here's a simple example:</p>
<div class="fragment"><div class="line">#include &quot;Particle.h&quot;</div>
<div class="line"> </div>
<div class="line">#include &quot;BackgroundPublishRK.h&quot;</div>
<div class="line"> </div>
<div class="line">SYSTEM_MODE(SEMI_AUTOMATIC);</div>
<div class="line">SYSTEM_THREAD(ENABLED);</div>
<div class="line"> </div>
<div class="line">SerialLogHandler logHandler;</div>
<div class="line"> </div>
<div class="line">const char *eventName = &quot;publishTest&quot;;</div>
<div class="line">int counter = 0;</div>
<div class="line">const unsigned long PUBLISH_INTERVAL_MS = 30000;</div>
<div class="line">unsigned long lastPublish = 0;</div>
<div class="line"> </div>
<div class="line">void publishCallback(publish_status_t status, const char *eventName, const char *eventData, const void *context);</div>
<div class="line"> </div>
<div class="line">void setup() {</div>
<div class="line">    // This must be called from setup() to start the background publishing thread</div>
<div class="line">    BackgroundPublishRK::instance().start();</div>
<div class="line">    Particle.connect();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">void loop() {</div>
<div class="line">    if (millis() - lastPublish &gt;= PUBLISH_INTERVAL_MS) {</div>
<div class="line">        lastPublish = millis();</div>
<div class="line"> </div>
<div class="line">        // This code runs every PUBLISH_INTERVAL_MS (currently 30 seconds)</div>
<div class="line"> </div>
<div class="line">        char data[64];</div>
<div class="line">        snprintf(data, sizeof(data), &quot;test %d&quot;, ++counter);</div>
<div class="line"> </div>
<div class="line">        // Use BackgroundPublishRK::instance().publish instead of Particle.publish</div>
<div class="line">        bool bResult = BackgroundPublishRK::instance().publish(eventName, data, PRIVATE | WITH_ACK, publishCallback);</div>
<div class="line">        Log.info(&quot;publish returned %d&quot;, bResult);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">void publishCallback(publish_status_t status, const char *eventName, const char *eventData, const void *context) {</div>
<div class="line">    Log.info(&quot;publishCallback status=%d&quot;, status);</div>
<div class="line">}</div>
</div><!-- fragment --><p >Basically, instead of calling:</p>
<div class="fragment"><div class="line">bool bResult = Particle.publish(eventName, data, PRIVATE | WITH_ACK);</div>
</div><!-- fragment --><p >You instead call:</p>
<div class="fragment"><div class="line">bool bResult = backgroundPublish.publish(eventName, data, PRIVATE | WITH_ACK, publishCallback);</div>
</div><!-- fragment --><p >This uses an optional asynchronous callback function to know whether the publish went out or not. This typically takes up to 20 seconds, though in some rare cases it could take up to 5 minutes.</p>
<p >There are a few cases with <code>backgroundPublish.publish()</code> returns <code>false</code> immediately:</p>
<ul>
<li>If the library has not been started or <code>name</code> is NULL, then this function returns false.</li>
<li>If there is already a publish in progress, then this function returns false.</li>
</ul>
<p >Otherwise, the function returns <code>true</code> and the optional callback will be called later with a boolean <code>succeeded</code> value.</p>
<p >It's common to use <code>WITH_ACK</code>, which will yield a fairly reliable definition of success. If you use <code>NO_ACK</code> then success merely means an attempt was made to publish the event, not that it was actually sent successfully.</p>
<p >Failure will occur if:</p>
<ul>
<li>The cloud is not connected. This should return failure quickly with 1.4.x. It may take longer with older versions of Device OS.</li>
<li>The event cannot be sent by the timeout (about 20 seconds).</li>
</ul>
<h1>Full API</h1>
<p >Background publish class. You typically instantiate one of these as a global variable.</p>
<h1>Members</h1>
<hr  />
<h2>void <a class="el" href="class_background_publish_r_k.html#a549f48ead5061bf819cba9a22d97ea08" title="Start the background publish thread. Required!">BackgroundPublishRK::start()</a></h2>
<p >Start the background publish thread. Required!</p>
<div class="fragment"><div class="line">void start()</div>
</div><!-- fragment --><p >You typically call this from setup() using:</p>
<div class="fragment"><div class="line"><a class="code hl_function" href="class_background_publish_r_k.html#a2c1064e5e3aa5997a31f70b89e1fccdb">BackgroundPublishRK::instance</a>().<a class="code hl_function" href="class_background_publish_r_k.html#a549f48ead5061bf819cba9a22d97ea08">start</a>();</div>
<div class="ttc" id="aclass_background_publish_r_k_html_a2c1064e5e3aa5997a31f70b89e1fccdb"><div class="ttname"><a href="class_background_publish_r_k.html#a2c1064e5e3aa5997a31f70b89e1fccdb">BackgroundPublishRK::instance</a></div><div class="ttdeci">static BackgroundPublishRK &amp; instance()</div><div class="ttdoc">Gets the singleton instance of this class.</div><div class="ttdef"><b>Definition:</b> BackgroundPublishRK.cpp:20</div></div>
<div class="ttc" id="aclass_background_publish_r_k_html_a549f48ead5061bf819cba9a22d97ea08"><div class="ttname"><a href="class_background_publish_r_k.html#a549f48ead5061bf819cba9a22d97ea08">BackgroundPublishRK::start</a></div><div class="ttdeci">void start()</div><div class="ttdoc">Start the background publish thread. Required!</div><div class="ttdef"><b>Definition:</b> BackgroundPublishRK.cpp:27</div></div>
</div><!-- fragment --><hr  />
<h2>void <a class="el" href="class_background_publish_r_k.html#ad07c078d539cdcdc7f7592f1cfdcf7d7" title="Stop the background publish thread.">BackgroundPublishRK::stop()</a></h2>
<p >Stop the background publish thread.</p>
<div class="fragment"><div class="line">void stop()</div>
</div><!-- fragment --><p >Normally you start it and never stop it, but this method is provided for special cases.</p>
<hr  />
<h2>bool <a class="el" href="class_background_publish_r_k.html#a9a1580a301e8c8a47df27377a5afe339" title="Publish method. Use this instead of Particle.publish().">BackgroundPublishRK::publish(const char * name, const char * data, PublishFlags flags, PublishCompletedCallback cb, const void * context)</a></h2>
<p >Publish method. Use this instead of Particle.publish().</p>
<div class="fragment"><div class="line">bool publish(const char * name, const char * data, PublishFlags flags, PublishCompletedCallback cb, const void * context)</div>
</div><!-- fragment --><h3>Parameters</h3>
<ul>
<li><code>name</code> Event name to publish (required)</li>
<li><code>data</code> Event data (optional). Must be a c-string (null-terminated) if non-NULL. Maximum length varies by Device OS, currently 622 bytes. Note that the data must be UTF-8; you cannot send arbitrary binary data!</li>
<li><code>flags</code> The publish flash. Default = PRIVATE. You will often use <code>PRIVATE | WITH_ACK</code> but can also use <code>PRIVATE | NO_ACK</code>.</li>
<li><code>cb</code> The callback function to call when the publish completes. Optional. Pass NULL or omit the parameter if you don't need a callback. It can be a C function or a C++11 lambda.</li>
<li><code>context</code> Optional parameter passed to the callback. You can store a C++ object instance or a state structure pointer here.</li>
</ul>
<hr  />
<h2>void <a class="el" href="class_background_publish_r_k.html#a00e0089962044b740ab2d35965188881" title="Used internally to mutex lock to safely access data structures from multiple threads.">BackgroundPublishRK::lock()</a></h2>
<p >Used internally to mutex lock to safely access data structures from multiple threads.</p>
<div class="fragment"><div class="line">void lock()</div>
</div><!-- fragment --><p >You do not need to use this under normal circumstances as publish() handles this internally.</p>
<hr  />
<h2>void <a class="el" href="class_background_publish_r_k.html#aa61a88079b0098d1edd30e800cd161bc" title="Used internally to mutex lock to safely access data structures from multiple threads.">BackgroundPublishRK::unlock()</a></h2>
<p >Used internally to mutex lock to safely access data structures from multiple threads.</p>
<div class="fragment"><div class="line">void unlock()</div>
</div><!-- fragment --><h1>Revision History</h1>
<h2>0.0.2 (2022-01-28)</h2>
<ul>
<li>Rename <a class="el" href="class_background_publish_r_k.html" title="Background publish class. You typically instantiate one of these as a global variable.">BackgroundPublishRK</a> class to <a class="el" href="class_background_publish_r_k.html" title="Background publish class. You typically instantiate one of these as a global variable.">BackgroundPublishRK</a> to avoid conflict with a class of the same name in Tracker Edge.</li>
</ul>
<h2>0.0.1 (2021-04-16)</h2>
<ul>
<li>Initial version </li>
</ul>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2
</small></address>
</body>
</html>
